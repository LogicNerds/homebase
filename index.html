<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Base</title>
    <style>
        :root {
            --chalkboard-bg: #2a2a2a;
            --chalk-text: #e8e8e8;
            --chalk-muted: #b0b0b0;
            --chalk-accent: #6dd4a8;
            --chalk-warning: #f4a261;
            --chalk-danger: #e63946;
            --card-bg: #3a3a3a;
            --card-border: #4a4a4a;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--chalkboard-bg);
            color: var(--chalk-text);
            min-height: 100vh; 
        }
        
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            min-height: 100vh; 
            background: var(--chalkboard-bg);
            box-shadow: 0 0 50px rgba(0,0,0,0.5); 
        }
        
        .hidden { display: none !important; }
        
        /* Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            background: var(--chalkboard-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }
        
        .splash-logo-placeholder {
            width: 200px;
            height: 200px;
            background: #4a4a4a;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: var(--chalk-muted);
            text-align: center;
            padding: 20px;
        }
        
        .splash-bg-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            z-index: -1;
        }
        
        /* Login Screen */
        .login-screen { 
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            padding: 40px 20px; 
            text-align: center; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            background: var(--chalkboard-bg);
        }
        
        .login-screen h1 { 
            color: var(--chalk-text);
            font-size: 3em; 
            margin-bottom: 15px; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); 
        }
        
        .login-screen p { 
            color: var(--chalk-muted);
            margin-bottom: 40px; 
            font-size: 0.95em; 
            font-style: italic; 
            line-height: 1.4; 
            max-width: 300px; 
        }
        
        .google-signin-btn { 
            background: var(--card-bg);
            color: var(--chalk-text);
            padding: 15px 40px; 
            border: 2px solid var(--card-border);
            border-radius: 8px; 
            font-size: 1em; 
            font-weight: 600; 
            cursor: pointer; 
            display: inline-flex; 
            align-items: center; 
            gap: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.2s; 
        }
        
        .google-signin-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            border-color: var(--chalk-accent);
        }
        
        .google-icon { width: 24px; height: 24px; }
        
        /* Setup Screen */
        .setup-screen { 
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            padding: 40px 20px; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            background: var(--chalkboard-bg);
        }
        
        .setup-screen h2 { 
            color: var(--chalk-text);
            margin-bottom: 30px; 
            text-align: center; 
        }
        
        .setup-card { 
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 20px; 
            padding: 30px 20px; 
            margin-bottom: 20px; 
            max-width: 400px; 
            width: 100%; 
        }
        
        .member-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            background: var(--chalkboard-bg);
            border-radius: 10px; 
            margin-bottom: 10px; 
        }
        
        .member-info { flex: 1; }
        
        .member-name { 
            font-weight: 600; 
            color: var(--chalk-text);
        }
        
        .member-email { 
            font-size: 0.85em; 
            color: var(--chalk-muted);
        }
        
        .member-role, .member-status { 
            padding: 4px 12px; 
            border-radius: 12px; 
            font-size: 0.85em; 
            font-weight: 600; 
        }
        
        .member-role.parent { 
            background: rgba(109, 212, 168, 0.2);
            color: var(--chalk-accent);
        }
        
        .member-role.child { 
            background: rgba(244, 162, 97, 0.2);
            color: var(--chalk-warning);
        }
        
        .member-status.pending { 
            background: rgba(244, 162, 97, 0.2);
            color: var(--chalk-warning);
        }
        
        /* Header with Logo Placeholder */
        .header { 
            background: var(--card-bg);
            border-bottom: 2px solid var(--card-border);
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .logo-placeholder {
            width: 40px;
            height: 40px;
            background: var(--card-border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            color: var(--chalk-muted);
            text-align: center;
            padding: 5px;
        }
        
        .header-right { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .user-avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            border: 2px solid var(--chalk-accent);
        }
        
        .logout-btn { 
            background: transparent;
            border: 1px solid var(--card-border);
            color: var(--chalk-text);
            padding: 8px 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.9em; 
            transition: all 0.2s; 
        }
        
        .logout-btn:hover { 
            background: var(--card-bg);
            border-color: var(--chalk-accent);
        }
        
        /* Horizontal Navigation Bar */
        .nav-bar {
            display: flex;
            background: var(--card-bg);
            border-bottom: 2px solid var(--card-border);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .nav-item {
            flex: 1;
            min-width: 80px;
            padding: 15px 10px;
            text-align: center;
            color: var(--chalk-muted);
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .nav-item:hover:not(.disabled) {
            color: var(--chalk-text);
            background: rgba(255,255,255,0.05);
        }
        
        .nav-item.active {
            color: var(--chalk-accent);
            border-bottom-color: var(--chalk-accent);
            background: rgba(109, 212, 168, 0.1);
        }
        
        .nav-item.disabled {
            color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* Main Content */
        .main-content { 
            padding: 20px 20px 80px 20px; 
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Stats Grid */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        
        .stat-card { 
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            color: var(--chalk-text);
            padding: 20px; 
            border-radius: 16px; 
            text-align: center; 
        }
        
        .stat-card.highlight { 
            border-color: var(--chalk-accent);
            background: rgba(109, 212, 168, 0.1);
        }
        
        .stat-value { 
            font-size: 2em; 
            font-weight: 700; 
            margin-bottom: 5px; 
            color: var(--chalk-accent);
        }
        
        .stat-label { 
            font-size: 0.85em; 
            color: var(--chalk-muted);
        }
        
        .help-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: var(--chalk-muted);
            color: var(--chalkboard-bg);
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 0.7em;
            font-weight: bold;
            cursor: pointer;
            margin-left: 5px;
            vertical-align: middle;
            position: relative;
        }
        
        .help-icon:hover {
            background: var(--chalk-accent);
        }
        
        .help-tooltip {
            display: none;
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            border: 2px solid var(--chalk-accent);
            color: var(--chalk-text);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85em;
            width: 200px;
            text-align: left;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            line-height: 1.4;
        }
        
        .help-tooltip.show {
            display: block;
        }
        
        .help-tooltip::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid var(--chalk-accent);
        }
        
        /* Section Headers */
        .section-header {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--chalk-text);
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--card-border);
        }
        
        /* Cards */
        .card { 
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 15px; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        
        .card:hover { 
            border-color: var(--chalk-accent);
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transform: translateY(-2px); 
        }
        
        .card.pending { 
            border-color: var(--chalk-warning);
            background: rgba(244, 162, 97, 0.1);
        }
        
        .card.side-mission {
            border-color: var(--chalk-accent);
            background: rgba(109, 212, 168, 0.1);
            box-shadow: 0 0 20px rgba(109, 212, 168, 0.2);
        }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
        }
        
        .card-title { 
            font-size: 1.2em; 
            font-weight: 600; 
            color: var(--chalk-text);
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .card-badge { 
            background: var(--chalk-accent);
            color: var(--chalkboard-bg);
            padding: 4px 12px; 
            border-radius: 12px; 
            font-size: 0.85em; 
            font-weight: 600; 
        }
        
        .card-badge.points { 
            background: var(--chalk-warning);
        }
        
        .card-badge.side-mission { 
            background: var(--chalk-accent);
            animation: shimmer 2s infinite; 
        }
        
        @keyframes shimmer { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.7; } 
        }
        
        .card-body { 
            color: var(--chalk-muted);
            font-size: 0.9em; 
            line-height: 1.4; 
        }
        
        .card-meta { 
            display: flex; 
            gap: 15px; 
            margin-top: 10px; 
            font-size: 0.85em; 
            color: var(--chalk-muted);
        }
        
        .card-actions { 
            display: flex; 
            gap: 10px; 
            margin-top: 15px; 
        }
        
        .card-btn { 
            flex: 1; 
            padding: 10px; 
            border: 1px solid var(--card-border);
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s;
            background: transparent;
            color: var(--chalk-text);
        }
        
        .card-btn.primary { 
            background: var(--chalk-accent);
            color: var(--chalkboard-bg);
            border-color: var(--chalk-accent);
        }
        
        .card-btn.success { 
            background: var(--chalk-accent);
            color: var(--chalkboard-bg);
            border-color: var(--chalk-accent);
        }
        
        .card-btn.danger { 
            background: var(--chalk-danger);
            color: white;
            border-color: var(--chalk-danger);
        }
        
        .card-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        /* Buttons */
        .action-btn, .add-btn { 
            width: 100%; 
            padding: 15px; 
            border-radius: 12px; 
            font-size: 0.95em; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
            margin-bottom: 15px; 
        }
        
        .action-btn { 
            border: none; 
            color: var(--chalkboard-bg);
            background: var(--chalk-accent);
        }
        
        .action-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(109, 212, 168, 0.4);
        }
        
        .add-btn { 
            background: transparent;
            border: 2px dashed var(--chalk-accent);
            color: var(--chalk-accent);
        }
        
        .add-btn:hover { 
            background: rgba(109, 212, 168, 0.1);
        }
        
        /* Routine Cards */
        .routine-card {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .routine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .routine-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--chalk-text);
        }
        
        .routine-task {
            padding: 10px 15px;
            background: var(--chalkboard-bg);
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .routine-task-text {
            color: var(--chalk-text);
        }
        
        .routine-task-delete {
            color: var(--chalk-danger);
            cursor: pointer;
            padding: 5px 10px;
        }
        
        /* Modals */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.8);
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        
        .modal.active { display: flex; }
        
        .modal-content { 
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 20px; 
            padding: 30px 20px; 
            max-width: 400px; 
            width: 100%; 
            max-height: 80vh; 
            overflow-y: auto; 
        }
        
        .modal-content h2 { 
            color: var(--chalk-text);
            margin-bottom: 20px; 
            font-size: 1.5em; 
        }
        
        .form-group { margin-bottom: 20px; }
        
        .checkbox-group { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .form-group label { 
            display: block; 
            color: var(--chalk-muted);
            margin-bottom: 8px; 
            font-weight: 600; 
            font-size: 0.9em; 
        }
        
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid var(--card-border);
            background: var(--chalkboard-bg);
            color: var(--chalk-text);
            border-radius: 10px; 
            font-size: 1em; 
            font-family: inherit; 
            transition: border-color 0.2s; 
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            outline: none; 
            border-color: var(--chalk-accent);
        }
        
        .form-group textarea { 
            resize: vertical; 
            min-height: 80px; 
        }
        
        .points-picker { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
        }
        
        .points-btn { 
            padding: 15px; 
            border: 2px solid var(--card-border);
            background: var(--chalkboard-bg);
            color: var(--chalk-text);
            border-radius: 10px; 
            font-size: 1.2em; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        
        .points-btn:hover { 
            border-color: var(--chalk-accent);
        }
        
        .points-btn.selected { 
            border-color: var(--chalk-accent);
            background: rgba(109, 212, 168, 0.2);
            color: var(--chalk-accent);
        }
        
        .modal-buttons { 
            display: flex; 
            gap: 10px; 
            margin-top: 25px; 
        }
        
        .modal-btn { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            border-radius: 12px; 
            font-size: 1em; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        
        .modal-btn.primary { 
            background: var(--chalk-accent);
            color: var(--chalkboard-bg);
        }
        
        .modal-btn.primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(109, 212, 168, 0.4);
        }
        
        .modal-btn.secondary { 
            background: transparent;
            border: 2px solid var(--card-border);
            color: var(--chalk-text);
        }
        
        .modal-btn.secondary:hover { 
            background: var(--card-bg);
        }
        
        /* Footer */
        .footer { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: var(--card-bg);
            border-top: 2px solid var(--card-border);
            color: var(--chalk-text);
            padding: 12px 20px; 
            text-align: center; 
            font-size: 0.85em; 
            z-index: 999; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        
        .footer a { 
            color: var(--chalk-accent);
            text-decoration: none; 
            cursor: pointer; 
            margin-left: 5px; 
        }
        
        .footer a:hover { 
            text-decoration: underline; 
        }
        
        /* Disclaimer Drawer */
        .disclaimer-drawer { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: var(--card-bg);
            border-top: 2px solid var(--card-border);
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s ease; 
            z-index: 1001; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        
        .disclaimer-drawer.open { 
            max-height: 80vh; 
            overflow-y: auto; 
        }
        
        .disclaimer-content { 
            padding: 30px 20px 80px 20px; 
            max-width: 600px; 
            margin: 0 auto; 
        }
        
        .disclaimer-content h3 { 
            color: var(--chalk-text);
            margin-bottom: 20px; 
            font-size: 1.5em; 
            text-align: center; 
        }
        
        .disclaimer-content p { 
            color: var(--chalk-muted);
            line-height: 1.6; 
            margin-bottom: 15px; 
            text-align: justify; 
        }
        
        .disclaimer-close { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            background: none; 
            border: none; 
            font-size: 1.8em; 
            cursor: pointer; 
            color: var(--chalk-muted);
            padding: 5px 10px; 
        }
        
        .disclaimer-close:hover { 
            color: var(--chalk-text);
        }
        
        .disclaimer-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.7);
            z-index: 1000; 
        }
        
        .disclaimer-overlay.active { 
            display: block; 
        }
        
        /* Completion Log Table */
        .completion-log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .completion-log-table th {
            background: var(--card-border);
            color: var(--chalk-text);
            padding: 10px;
            text-align: left;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .completion-log-table td {
            padding: 10px;
            border-bottom: 1px solid var(--card-border);
            color: var(--chalk-muted);
            font-size: 0.85em;
        }
        
        .completion-log-table tr:hover {
            background: var(--card-bg);
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .header h1 { font-size: 1.6em; }
            .user-avatar { width: 32px; height: 32px; }
            .action-btn { padding: 12px 8px; font-size: 0.85em; }
            .nav-item { font-size: 0.8em; padding: 12px 8px; }
            .completion-log-table th,
            .completion-log-table td { 
                padding: 8px 5px; 
                font-size: 0.75em; 
            }
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen">
        <div class="splash-bg-placeholder"></div>
        <div class="splash-logo-placeholder">LOGO<br>HERE</div>
        <h2 style="color: var(--chalk-text);">Home Base</h2>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen hidden">
        <h1>üè† Home Base</h1>
        <p>Your mission control center for family tasks and routines</p>
        <button class="google-signin-btn" onclick="signInWithGoogle()">
            <svg class="google-icon" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Sign in with Google
        </button>
    </div>

    <!-- Setup Screen -->
    <div id="setupScreen" class="setup-screen hidden">
        <h2>Welcome to Home Base!</h2>
        <div class="setup-card">
            <h3 style="margin-bottom: 20px; color: var(--chalk-text);">Create Your Family</h3>
            <div class="form-group">
                <label>Family Name</label>
                <input type="text" id="familyName" placeholder="The Smith Family">
            </div>
            <button class="action-btn" onclick="createFamily()">Create Family</button>
        </div>
        <div class="setup-card">
            <h3 style="margin-bottom: 20px; color: var(--chalk-text);">Join Existing Family</h3>
            <div class="form-group">
                <label>Invite Code</label>
                <input type="text" id="inviteCode" placeholder="ABC123" style="text-transform: uppercase;">
            </div>
            <button class="action-btn" onclick="joinFamily()">Join Family</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container hidden">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="logo-placeholder">LOGO</div>
                <h2 style="font-size: 1.2em; font-weight: 600; margin: 0; color: var(--chalk-text);">Home Base</h2>
            </div>
            <div class="header-right">
                <img id="userAvatar" class="user-avatar" src="" alt="User">
                <button class="logout-btn" onclick="signOut()">Logout</button>
            </div>
        </div>

        <!-- Horizontal Navigation Bar -->
        <div class="nav-bar">
            <div class="nav-item active" onclick="switchTab('home')">Home</div>
            <div class="nav-item" onclick="switchTab('routines')">Routines</div>
            <div class="nav-item" onclick="switchTab('stats')">Stats</div>
            <div class="nav-item disabled" id="recRoomNav" onclick="switchTab('recroom')">Rec Room</div>
            <div class="nav-item hidden" id="missionControlNav" onclick="switchTab('missioncontrol')">Mission Control</div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- HOME TAB -->
            <div id="homeTab" class="tab-content active">
                <button class="add-btn" onclick="showModal('addMissionModal')">+ Add Mission</button>
                
                <div class="section-header">Active Missions</div>
                <div id="activeMissionsList"></div>
                
                <div class="section-header">Requested Missions</div>
                <div id="requestedMissionsList"></div>
            </div>

            <!-- ROUTINES TAB -->
            <div id="routinesTab" class="tab-content">
                <button class="add-btn" onclick="showModal('addRoutineModal')">+ Create Routine</button>
                <div id="routinesList"></div>
            </div>

            <!-- STATS TAB -->
            <div id="statsTab" class="tab-content">
                <div class="section-header">My Stats</div>
                <div class="stats-grid" id="personalStats"></div>
                
                <!-- Family Dashboard (Parents Only) -->
                <div id="familyDashboard" class="hidden">
                    <div class="section-header">Family Dashboard</div>
                    <div id="familyMembersList"></div>
                </div>
            </div>

            <!-- REC ROOM TAB -->
            <div id="recroomTab" class="tab-content">
                <div class="section-header">Rec Room</div>
                <p style="color: var(--chalk-muted); text-align: center; margin-top: 40px;">
                    Game links coming soon!
                </p>
            </div>

            <!-- MISSION CONTROL TAB (Parents Only) -->
            <div id="missioncontrolTab" class="tab-content">
                <div class="section-header">Family Settings</div>
                
                <div class="card">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="streaksToggle" onchange="toggleFamilySetting('streaksEnabled')">
                            <label for="streaksToggle" style="margin: 0;">Enable Daily Streaks</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="kidsTasksToggle" onchange="toggleFamilySetting('kidsCanCreateTasks')">
                            <label for="kidsTasksToggle" style="margin: 0;">Kids Can Create Tasks</label>
                        </div>
                    </div>
                </div>

                <div class="section-header">Completion Log</div>
                <div id="completionLogList"></div>

                <div class="section-header">Data Management</div>
                <button class="add-btn" onclick="resetFamilyData()" style="background: transparent; border-color: var(--chalk-danger); color: var(--chalk-danger);">
                    ‚ö†Ô∏è Reset All Family Data
                </button>
                <p style="color: var(--chalk-muted); font-size: 0.85em; margin-top: -10px; margin-bottom: 20px; text-align: center; font-style: italic;">
                    üí° Tip: Use reset to start fresh each week or month. All missions and completion history will be deleted.
                </p>

                <div class="section-header">Family Members</div>
                <div id="missionControlMembersList"></div>

                <div class="section-header">Family Code</div>
                <div class="card">
                    <div style="text-align: center;">
                        <p style="color: var(--chalk-muted); margin-bottom: 10px;">Share this code with family members:</p>
                        <p style="font-size: 2em; font-weight: 700; color: var(--chalk-accent);" id="familyInviteCode"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Mission Modal -->
    <div id="addMissionModal" class="modal">
        <div class="modal-content">
            <h2 id="addMissionModalTitle">Add Mission</h2>
            <div class="form-group">
                <label>Mission Title</label>
                <input type="text" id="missionTitle" placeholder="Clean your room">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="missionDescription" placeholder="Make bed, vacuum, organize desk..."></textarea>
            </div>
            <div class="form-group">
                <label>Due Date</label>
                <input type="date" id="missionDueDate">
            </div>
            <div class="form-group" id="missionPointsGroup">
                <label>Points (10-100)</label>
                <div class="points-picker">
                    <button type="button" class="points-btn selected" onclick="selectMissionPoints(10, this)">10</button>
                    <button type="button" class="points-btn" onclick="selectMissionPoints(25, this)">25</button>
                    <button type="button" class="points-btn" onclick="selectMissionPoints(50, this)">50</button>
                    <button type="button" class="points-btn" onclick="selectMissionPoints(75, this)">75</button>
                    <button type="button" class="points-btn" onclick="selectMissionPoints(100, this)">100</button>
                </div>
            </div>
            <div class="form-group" id="missionSideMissionGroup">
                <div class="checkbox-group">
                    <input type="checkbox" id="missionSideMission">
                    <label for="missionSideMission" style="margin: 0;">Side Mission (High Priority)</label>
                </div>
            </div>
            <div class="form-group" id="missionAssigneeGroup">
                <label>Assign To</label>
                <select id="missionAssignee">
                    <option value="anyone">Anyone</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('addMissionModal')">Cancel</button>
                <button class="modal-btn primary" onclick="addMission()">Add Mission</button>
            </div>
        </div>
    </div>

    <!-- Add Routine Modal -->
    <div id="addRoutineModal" class="modal">
        <div class="modal-content">
            <h2>Create Routine</h2>
            <div class="form-group">
                <label>Routine Name</label>
                <input type="text" id="routineName" placeholder="Morning Routine">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('addRoutineModal')">Cancel</button>
                <button class="modal-btn primary" onclick="addRoutine()">Create</button>
            </div>
        </div>
    </div>

    <!-- Add Task to Routine Modal -->
    <div id="addTaskToRoutineModal" class="modal">
        <div class="modal-content">
            <h2>Add Task to Routine</h2>
            <div class="form-group">
                <label>Task</label>
                <input type="text" id="routineTaskText" placeholder="Brush teeth">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('addTaskToRoutineModal')">Cancel</button>
                <button class="modal-btn primary" onclick="addTaskToRoutine()">Add Task</button>
            </div>
        </div>
    </div>

    <!-- Edit Mission Modal -->
    <div id="editMissionModal" class="modal">
        <div class="modal-content">
            <h2>Edit Mission</h2>
            <div class="form-group">
                <label>Mission Title</label>
                <input type="text" id="editMissionTitle">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="editMissionDescription"></textarea>
            </div>
            <div class="form-group">
                <label>Due Date</label>
                <input type="date" id="editMissionDueDate">
            </div>
            <div class="form-group">
                <label>Points (10-100)</label>
                <div class="points-picker">
                    <button type="button" class="points-btn" onclick="selectEditMissionPoints(10, this)">10</button>
                    <button type="button" class="points-btn" onclick="selectEditMissionPoints(25, this)">25</button>
                    <button type="button" class="points-btn" onclick="selectEditMissionPoints(50, this)">50</button>
                    <button type="button" class="points-btn" onclick="selectEditMissionPoints(75, this)">75</button>
                    <button type="button" class="points-btn" onclick="selectEditMissionPoints(100, this)">100</button>
                </div>
            </div>
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="editMissionSideMission">
                    <label for="editMissionSideMission" style="margin: 0;">Side Mission</label>
                </div>
            </div>
            <div class="form-group">
                <label>Assign To</label>
                <select id="editMissionAssignee">
                    <option value="anyone">Anyone</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('editMissionModal')">Cancel</button>
                <button class="modal-btn primary" onclick="updateMission()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content">
            <h2>Edit Member</h2>
            <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="editMemberName">
            </div>
            <div class="form-group">
                <label>Points Goal</label>
                <input type="number" id="editMemberGoal" placeholder="100">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('editMemberModal')">Cancel</button>
                <button class="modal-btn primary" onclick="updateMember()">Save</button>
            </div>
        </div>
    </div>

    <!-- Disclaimer Overlay -->
    <div id="disclaimerOverlay" class="disclaimer-overlay" onclick="closeDisclaimer()"></div>

    <!-- Disclaimer Drawer -->
    <div id="disclaimerDrawer" class="disclaimer-drawer">
        <button class="disclaimer-close" onclick="closeDisclaimer()">√ó</button>
        <div class="disclaimer-content">
            <h3>Disclaimer</h3>
            <p>This application is provided for personal tracking purposes only and is not intended to serve as professional advice. Home Base is designed for family task management and should not be treated as a substitute for professional organizational services.</p>
            <p>Users are solely responsible for the accuracy of data entered and any decisions made. Logic Nerds and its affiliates assume no liability for any losses, damages, or consequences arising from the use or misuse of this application.</p>
            <p>This software is provided "as is" without warranty of any kind, express or implied. By using this application, you acknowledge and accept full responsibility for your data and decisions.</p>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        ¬© 2026 Logic Nerds. All Rights Reserved. | <a onclick="openDisclaimer()">Disclaimer</a>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut as firebaseSignOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, where, getDocs, onSnapshot, serverTimestamp, orderBy, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDtBO48uBogqcdv69VO9IH7MIG8Kb1YG10",
            authDomain: "idk-money-tracker.firebaseapp.com",
            projectId: "idk-money-tracker",
            storageBucket: "idk-money-tracker.firebasestorage.app",
            messagingSenderId: "1033439716188",
            appId: "1:1033439716188:web:ebf8c149f68d3d568f9799",
            measurementId: "G-KEZSNJZ4JW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentFamily = null;
        let currentMember = null;
        let allMembers = [];
        let missions = [];
        let routines = [];
        let completions = [];
        let unsubscribeFamilyListener = null;
        let unsubscribeMembersListener = null;
        let unsubscribeMissionsListener = null;
        let unsubscribeRoutinesListener = null;
        let unsubscribeCompletionsListener = null;
        let selectedMissionPoints = 10;
        let selectedEditMissionPoints = 10;
        let currentEditMissionId = null;
        let currentEditMemberId = null;
        let currentRoutineId = null;
        let currentTab = 'home';

        // Hide splash screen after 2 seconds
        setTimeout(() => {
            document.getElementById('splashScreen').classList.add('hidden');
        }, 2000);

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await checkMembership();
            } else {
                currentUser = null;
                showScreen('login');
            }
        });

        async function checkMembership() {
            const membersQuery = query(collection(db, 'members'), where('userId', '==', currentUser.uid));
            const membersSnapshot = await getDocs(membersQuery);

            if (membersSnapshot.empty) {
                showScreen('setup');
            } else {
                const memberDoc = membersSnapshot.docs[0];
                currentMember = { id: memberDoc.id, ...memberDoc.data() };
                await loadFamily();
                showScreen('main');
                loadAllData();
            }
        }

        async function loadFamily() {
            const familyDoc = await getDoc(doc(db, 'families', currentMember.familyId));
            if (familyDoc.exists()) {
                currentFamily = { id: familyDoc.id, ...familyDoc.data() };
            }
        }

        function loadAllData() {
            loadFamilyData();
            loadMembersData();
            loadMissionsData();
            loadRoutinesData();
            loadCompletionsData();
            updateNavigation();
        }

        function updateNavigation() {
            const isParent = currentMember && currentMember.role === 'parent';
            const recRoomNav = document.getElementById('recRoomNav');
            const missionControlNav = document.getElementById('missionControlNav');

            if (isParent) {
                recRoomNav.classList.remove('disabled');
                missionControlNav.classList.remove('hidden');
            } else {
                // Check if rec room is enabled for this child
                if (currentMember.recRoomEnabled) {
                    recRoomNav.classList.remove('disabled');
                } else {
                    recRoomNav.classList.add('disabled');
                }
                missionControlNav.classList.add('hidden');
            }
        }

        function loadFamilyData() {
            if (!currentFamily) return;
            
            if (unsubscribeFamilyListener) unsubscribeFamilyListener();
            
            unsubscribeFamilyListener = onSnapshot(doc(db, 'families', currentFamily.id), (doc) => {
                if (doc.exists()) {
                    currentFamily = { id: doc.id, ...doc.data() };
                    updateFamilyUI();
                }
            });
        }

        function loadMembersData() {
            if (!currentFamily) return;
            
            if (unsubscribeMembersListener) unsubscribeMembersListener();
            
            const membersQuery = query(collection(db, 'members'), where('familyId', '==', currentFamily.id));
            unsubscribeMembersListener = onSnapshot(membersQuery, (snapshot) => {
                allMembers = [];
                snapshot.forEach((doc) => {
                    allMembers.push({ id: doc.id, ...doc.data() });
                });
                updateMembersUI();
                updateAssigneeDropdowns();
            });
        }

        function loadMissionsData() {
            if (!currentFamily) return;
            
            if (unsubscribeMissionsListener) unsubscribeMissionsListener();
            
            const missionsQuery = query(
                collection(db, 'missions'), 
                where('familyId', '==', currentFamily.id)
            );
            
            unsubscribeMissionsListener = onSnapshot(missionsQuery, (snapshot) => {
                missions = [];
                snapshot.forEach((doc) => {
                    missions.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort missions client-side by due date (null dates go to end)
                missions.sort((a, b) => {
                    if (!a.dueDate && !b.dueDate) return 0;
                    if (!a.dueDate) return 1;
                    if (!b.dueDate) return -1;
                    return new Date(a.dueDate) - new Date(b.dueDate);
                });
                
                updateMissionsUI();
            });
        }

        function loadRoutinesData() {
            if (!currentUser) return;
            
            if (unsubscribeRoutinesListener) unsubscribeRoutinesListener();
            
            const routinesQuery = query(
                collection(db, 'routines'),
                where('userId', '==', currentUser.uid)
            );
            
            unsubscribeRoutinesListener = onSnapshot(routinesQuery, (snapshot) => {
                routines = [];
                snapshot.forEach((doc) => {
                    routines.push({ id: doc.id, ...doc.data() });
                });
                updateRoutinesUI();
            });
        }

        function loadCompletionsData() {
            if (!currentFamily) return;
            
            if (unsubscribeCompletionsListener) unsubscribeCompletionsListener();
            
            const completionsQuery = query(
                collection(db, 'completions'),
                where('familyId', '==', currentFamily.id)
            );
            
            unsubscribeCompletionsListener = onSnapshot(completionsQuery, (snapshot) => {
                completions = [];
                snapshot.forEach((doc) => {
                    completions.push({ id: doc.id, ...doc.data() });
                });
                updateStatsUI();
                updateFamilyDashboard();
                updateCompletionLog();
            });
        }

        function updateFamilyUI() {
            if (!currentFamily) return;
            
            // Update family settings checkboxes
            const streaksToggle = document.getElementById('streaksToggle');
            const kidsTasksToggle = document.getElementById('kidsTasksToggle');
            
            if (streaksToggle && currentFamily.settings) {
                streaksToggle.checked = currentFamily.settings.streaksEnabled || false;
            }
            
            if (kidsTasksToggle && currentFamily.settings) {
                kidsTasksToggle.checked = currentFamily.settings.kidsCanCreateTasks || false;
            }
            
            // Update invite code display
            const inviteCodeEl = document.getElementById('familyInviteCode');
            if (inviteCodeEl && currentFamily.inviteCode) {
                inviteCodeEl.textContent = currentFamily.inviteCode;
            }
        }

        function updateMembersUI() {
            updateFamilyDashboard();
            updateMissionControlMembers();
        }

        function updateFamilyDashboard() {
            const isParent = currentMember && currentMember.role === 'parent';
            const dashboardEl = document.getElementById('familyDashboard');
            
            if (!isParent) {
                dashboardEl.classList.add('hidden');
                return;
            }
            
            dashboardEl.classList.remove('hidden');
            const membersList = document.getElementById('familyMembersList');
            membersList.innerHTML = '';
            
            allMembers.forEach(member => {
                const memberPoints = completions.filter(c => c.memberId === member.id)
                    .reduce((sum, c) => sum + (c.points || 0), 0);
                
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">${member.name || member.email}</div>
                        <div class="card-badge ${member.role}">${member.role}</div>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 20px; margin-top: 10px;">
                            <div>
                                <div style="font-size: 1.5em; font-weight: 700; color: var(--chalk-accent);">${memberPoints}</div>
                                <div style="font-size: 0.85em; color: var(--chalk-muted);">Points</div>
                            </div>
                        </div>
                    </div>
                `;
                membersList.appendChild(card);
            });
        }

        function updateMissionControlMembers() {
            const isParent = currentMember && currentMember.role === 'parent';
            if (!isParent) return;
            
            const membersList = document.getElementById('missionControlMembersList');
            membersList.innerHTML = '';
            
            allMembers.forEach(member => {
                const card = document.createElement('div');
                card.className = 'card';
                
                // Check if this is the current user and if they're the only parent
                const isCurrentUser = member.id === currentMember.id;
                const parentCount = allMembers.filter(m => m.role === 'parent').length;
                const isOnlyParent = member.role === 'parent' && parentCount === 1;
                const canRemove = !isCurrentUser && !isOnlyParent;
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">${member.name || member.email}</div>
                        <div class="card-badge ${member.role}">${member.role}</div>
                    </div>
                    <div class="card-body">
                        <div style="color: var(--chalk-muted); font-size: 0.9em; margin-bottom: 10px;">${member.email}</div>
                    </div>
                    <div class="card-actions">
                        <button class="card-btn primary" onclick="editMember('${member.id}')">Edit</button>
                        ${member.role === 'child' ? `
                            <button class="card-btn ${member.recRoomEnabled ? 'danger' : 'success'}" 
                                    onclick="toggleRecRoom('${member.id}', ${!member.recRoomEnabled})">
                                ${member.recRoomEnabled ? 'Close' : 'Open'} Rec Room
                            </button>
                        ` : ''}
                        ${canRemove ? `
                            <button class="card-btn danger" onclick="removeMember('${member.id}')">Remove</button>
                        ` : ''}
                        ${isCurrentUser ? `
                            <span style="color: var(--chalk-muted); font-size: 0.85em; padding: 10px;">(You)</span>
                        ` : ''}
                        ${isOnlyParent && !isCurrentUser ? `
                            <span style="color: var(--chalk-muted); font-size: 0.85em; padding: 10px;">(Only Parent)</span>
                        ` : ''}
                    </div>
                `;
                membersList.appendChild(card);
            });
            
            // Update completion log
            updateCompletionLog();
        }

        function updateCompletionLog() {
            const isParent = currentMember && currentMember.role === 'parent';
            if (!isParent) return;
            
            const logList = document.getElementById('completionLogList');
            
            // Sort completions by date (most recent first)
            const sortedCompletions = [...completions].sort((a, b) => {
                const dateA = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt);
                const dateB = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt);
                return dateB - dateA;
            });
            
            if (sortedCompletions.length === 0) {
                logList.innerHTML = '<p style="color: var(--chalk-muted); text-align: center; padding: 20px;">No completed missions yet</p>';
                return;
            }
            
            // Show only the most recent 20 completions
            const recentCompletions = sortedCompletions.slice(0, 20);
            
            let tableHTML = `
                <table class="completion-log-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Mission</th>
                            <th>Date</th>
                            <th>Points</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            recentCompletions.forEach(completion => {
                const date = completion.completedAt?.toDate ? 
                    completion.completedAt.toDate() : 
                    new Date(completion.completedAt);
                const dateStr = date.toLocaleDateString();
                
                tableHTML += `
                    <tr>
                        <td>${completion.memberName || 'Unknown'}</td>
                        <td>${completion.missionTitle || 'Unknown Mission'}</td>
                        <td>${dateStr}</td>
                        <td style="color: var(--chalk-accent); font-weight: 600;">${completion.points}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            if (sortedCompletions.length > 20) {
                tableHTML += `<p style="color: var(--chalk-muted); text-align: center; margin-top: 10px; font-size: 0.85em;">Showing 20 most recent completions</p>`;
            }
            
            logList.innerHTML = tableHTML;
        }

        function updateAssigneeDropdowns() {
            const assigneeSelects = [
                document.getElementById('missionAssignee'),
                document.getElementById('editMissionAssignee')
            ];
            
            assigneeSelects.forEach(select => {
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="anyone">Anyone</option>';
                
                // Add all family members including parents
                allMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name || member.email;
                    select.appendChild(option);
                });
                
                if (currentValue) select.value = currentValue;
            });
        }

        function updateMissionsUI() {
            const isParent = currentMember && currentMember.role === 'parent';
            
            // Filter missions for current member
            const activeMissions = missions.filter(m => {
                if (m.status !== 'active') return false;
                // Show missions assigned to this member, to "anyone", or created by this parent
                return m.assignedTo === currentMember.id || 
                       m.assignedTo === 'anyone' || 
                       (isParent && m.createdBy === currentUser.uid);
            });
            
            const requestedMissions = missions.filter(m => {
                if (m.status !== 'pending') return false;
                if (isParent) return true; // Parents see all pending
                return m.createdBy === currentUser.uid; // Kids see their own requests
            });
            
            // Update active missions list
            const activeList = document.getElementById('activeMissionsList');
            activeList.innerHTML = '';
            
            if (activeMissions.length === 0) {
                activeList.innerHTML = '<p style="color: var(--chalk-muted); text-align: center; padding: 20px;">No active missions</p>';
            } else {
                activeMissions.forEach(mission => {
                    const card = createMissionCard(mission, isParent);
                    activeList.appendChild(card);
                });
            }
            
            // Update requested missions list
            const requestedList = document.getElementById('requestedMissionsList');
            requestedList.innerHTML = '';
            
            if (requestedMissions.length === 0) {
                requestedList.innerHTML = '<p style="color: var(--chalk-muted); text-align: center; padding: 20px;">No requested missions</p>';
            } else {
                requestedMissions.forEach(mission => {
                    const card = createMissionCard(mission, isParent);
                    requestedList.appendChild(card);
                });
            }
        }

        function createMissionCard(mission, isParent) {
            const card = document.createElement('div');
            const isPending = mission.status === 'pending';
            const isSideMission = mission.sideMission;
            
            card.className = `card ${isPending ? 'pending' : ''} ${isSideMission ? 'side-mission' : ''}`;
            
            const assignedMember = allMembers.find(m => m.id === mission.assignedTo);
            const assignedName = mission.assignedTo === 'anyone' ? 'Anyone' : (assignedMember?.name || 'Unassigned');
            
            const dueDate = mission.dueDate ? new Date(mission.dueDate).toLocaleDateString() : 'No due date';
            
            let actionsHTML = '';
            if (isPending && isParent) {
                actionsHTML = `
                    <div class="card-actions">
                        <button class="card-btn success" onclick="approveMission('${mission.id}', event)">Approve</button>
                        <button class="card-btn danger" onclick="deleteMission('${mission.id}', event)">Reject</button>
                    </div>
                `;
            } else if (!isPending) {
                actionsHTML = `
                    <div class="card-actions">
                        <button class="card-btn success" onclick="completeMission('${mission.id}', event)">Complete</button>
                        ${isParent || mission.createdBy === currentUser.uid ? 
                            `<button class="card-btn primary" onclick="editMission('${mission.id}', event)">Edit</button>
                             <button class="card-btn danger" onclick="deleteMission('${mission.id}', event)">Delete</button>` 
                        : ''}
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title">${mission.title}</div>
                    <div>
                        ${isSideMission ? '<span class="card-badge side-mission">‚≠ê Side Mission</span>' : ''}
                        <span class="card-badge points">${mission.points} pts</span>
                    </div>
                </div>
                <div class="card-body">${mission.description || 'No description'}</div>
                <div class="card-meta">
                    <span>üìÖ ${dueDate}</span>
                    <span>üë§ ${assignedName}</span>
                </div>
                ${actionsHTML}
            `;
            
            return card;
        }

        function updateRoutinesUI() {
            const routinesList = document.getElementById('routinesList');
            routinesList.innerHTML = '';
            
            if (routines.length === 0) {
                routinesList.innerHTML = '<p style="color: var(--chalk-muted); text-align: center; padding: 20px;">No routines yet</p>';
                return;
            }
            
            routines.forEach(routine => {
                const card = document.createElement('div');
                card.className = 'routine-card';
                
                const tasksHTML = (routine.tasks || []).map((task, index) => `
                    <div class="routine-task">
                        <span class="routine-task-text">${task}</span>
                        <span class="routine-task-delete" onclick="deleteTaskFromRoutine('${routine.id}', ${index}, event)">√ó</span>
                    </div>
                `).join('');
                
                card.innerHTML = `
                    <div class="routine-header">
                        <div class="routine-title">${routine.name}</div>
                        <button class="card-btn danger" onclick="deleteRoutine('${routine.id}', event)" style="width: auto; padding: 6px 10px; flex: none;">Delete</button>
                    </div>
                    <div>${tasksHTML || '<p style="color: var(--chalk-muted); font-size: 0.9em;">No tasks yet</p>'}</div>
                    <button class="add-btn" onclick="showAddTaskToRoutine('${routine.id}')" style="margin-top: 15px;">+ Add Task</button>
                `;
                
                routinesList.appendChild(card);
            });
        }

        function updateStatsUI() {
            const personalStats = document.getElementById('personalStats');
            
            // Calculate personal stats
            const myCompletions = completions.filter(c => c.memberId === currentMember.id);
            const totalPoints = myCompletions.reduce((sum, c) => sum + (c.points || 0), 0);
            const activeMissionsCount = missions.filter(m => {
                if (m.status !== 'active') return false;
                return m.assignedTo === currentMember.id || m.assignedTo === 'anyone';
            }).length;
            
            personalStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalPoints}</div>
                    <div class="stat-label">
                        Total Points
                        <span class="help-icon" onclick="toggleHelpTooltip(event)">
                            ?
                            <div class="help-tooltip">Points decay 10% per day when missions are completed late (max 90% decay). Complete on time for full points!</div>
                        </span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${activeMissionsCount}</div>
                    <div class="stat-label">Active Missions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${myCompletions.length}</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${routines.length}</div>
                    <div class="stat-label">Routines</div>
                </div>
            `;
        }

        // Auth Functions
        window.signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Sign in failed. Please try again.');
            }
        };

        window.signOut = async () => {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    if (unsubscribeFamilyListener) unsubscribeFamilyListener();
                    if (unsubscribeMembersListener) unsubscribeMembersListener();
                    if (unsubscribeMissionsListener) unsubscribeMissionsListener();
                    if (unsubscribeRoutinesListener) unsubscribeRoutinesListener();
                    if (unsubscribeCompletionsListener) unsubscribeCompletionsListener();
                    await firebaseSignOut(auth);
                } catch (error) {
                    console.error('Sign out error:', error);
                    alert('Sign out failed. Please try again.');
                }
            }
        };

        // Family Setup Functions
        window.createFamily = async () => {
            const familyName = document.getElementById('familyName').value.trim();
            if (!familyName) {
                alert('Please enter a family name');
                return;
            }

            try {
                // Generate unique invite code with collision checking
                let inviteCode;
                let isUnique = false;
                let attempts = 0;
                const maxAttempts = 10;
                
                while (!isUnique && attempts < maxAttempts) {
                    // Generate 6-character code (uppercase letters and numbers)
                    inviteCode = '';
                    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Removed confusing chars: 0,O,1,I
                    for (let i = 0; i < 6; i++) {
                        inviteCode += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    
                    // Check if code already exists
                    const existingFamily = query(collection(db, 'families'), where('inviteCode', '==', inviteCode));
                    const snapshot = await getDocs(existingFamily);
                    
                    if (snapshot.empty) {
                        isUnique = true;
                    }
                    attempts++;
                }
                
                if (!isUnique) {
                    alert('Failed to generate unique invite code. Please try again.');
                    return;
                }
                
                const familyRef = await addDoc(collection(db, 'families'), {
                    name: familyName,
                    inviteCode: inviteCode,
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    settings: {
                        streaksEnabled: true,
                        kidsCanCreateTasks: true
                    }
                });

                await addDoc(collection(db, 'members'), {
                    userId: currentUser.uid,
                    familyId: familyRef.id,
                    email: currentUser.email,
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    role: 'parent',
                    recRoomEnabled: true,
                    createdAt: serverTimestamp()
                });

                await checkMembership();
            } catch (error) {
                console.error('Error creating family:', error);
                alert('Failed to create family. Please try again.');
            }
        };

        window.joinFamily = async () => {
            const inviteCode = document.getElementById('inviteCode').value.trim().toUpperCase();
            if (!inviteCode) {
                alert('Please enter an invite code');
                return;
            }

            try {
                const familiesQuery = query(collection(db, 'families'), where('inviteCode', '==', inviteCode));
                const familiesSnapshot = await getDocs(familiesQuery);

                if (familiesSnapshot.empty) {
                    alert('Invalid invite code');
                    return;
                }

                const familyDoc = familiesSnapshot.docs[0];

                await addDoc(collection(db, 'members'), {
                    userId: currentUser.uid,
                    familyId: familyDoc.id,
                    email: currentUser.email,
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    role: 'child',
                    recRoomEnabled: false,
                    createdAt: serverTimestamp()
                });

                await checkMembership();
            } catch (error) {
                console.error('Error joining family:', error);
                alert('Failed to join family. Please try again.');
            }
        };

        // Mission Functions
        window.addMission = async () => {
            const title = document.getElementById('missionTitle').value.trim();
            const description = document.getElementById('missionDescription').value.trim();
            const dueDate = document.getElementById('missionDueDate').value;
            const assignedTo = document.getElementById('missionAssignee').value;
            const sideMission = document.getElementById('missionSideMission').checked;
            
            if (!title) {
                alert('Please enter a mission title');
                return;
            }

            const isParent = currentMember && currentMember.role === 'parent';
            
            try {
                await addDoc(collection(db, 'missions'), {
                    familyId: currentFamily.id,
                    title: title,
                    description: description,
                    dueDate: dueDate,
                    points: selectedMissionPoints,
                    assignedTo: isParent ? assignedTo : 'anyone',
                    sideMission: isParent ? sideMission : false,
                    status: isParent ? 'active' : 'pending',
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                
                closeModal('addMissionModal');
                document.getElementById('missionTitle').value = '';
                document.getElementById('missionDescription').value = '';
                document.getElementById('missionDueDate').value = '';
                document.getElementById('missionSideMission').checked = false;
                selectedMissionPoints = 10;
            } catch (error) {
                console.error('Error adding mission:', error);
                alert('Failed to add mission. Please try again.');
            }
        };

        window.editMission = (missionId, event) => {
            event.stopPropagation();
            currentEditMissionId = missionId;
            const mission = missions.find(m => m.id === missionId);
            if (!mission) return;
            
            document.getElementById('editMissionTitle').value = mission.title;
            document.getElementById('editMissionDescription').value = mission.description || '';
            document.getElementById('editMissionDueDate').value = mission.dueDate || '';
            document.getElementById('editMissionSideMission').checked = mission.sideMission || false;
            document.getElementById('editMissionAssignee').value = mission.assignedTo || 'anyone';
            
            selectedEditMissionPoints = mission.points || 10;
            document.querySelectorAll('#editMissionModal .points-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.textContent) === selectedEditMissionPoints);
            });
            
            showModal('editMissionModal');
        };

        window.updateMission = async () => {
            if (!currentEditMissionId) return;
            
            const title = document.getElementById('editMissionTitle').value.trim();
            const description = document.getElementById('editMissionDescription').value.trim();
            const dueDate = document.getElementById('editMissionDueDate').value;
            const assignedTo = document.getElementById('editMissionAssignee').value;
            const sideMission = document.getElementById('editMissionSideMission').checked;
            
            if (!title) {
                alert('Please enter a mission title');
                return;
            }

            try {
                await updateDoc(doc(db, 'missions', currentEditMissionId), {
                    title: title,
                    description: description,
                    dueDate: dueDate,
                    points: selectedEditMissionPoints,
                    assignedTo: assignedTo,
                    sideMission: sideMission
                });
                
                closeModal('editMissionModal');
                currentEditMissionId = null;
            } catch (error) {
                console.error('Error updating mission:', error);
                alert('Failed to update mission. Please try again.');
            }
        };

        window.deleteMission = async (missionId, event) => {
            event.stopPropagation();
            
            const mission = missions.find(m => m.id === missionId);
            if (!mission) return;
            
            if (confirm(`Delete mission "${mission.title}"?`)) {
                try {
                    await deleteDoc(doc(db, 'missions', missionId));
                } catch (error) {
                    console.error('Error deleting mission:', error);
                    alert('Failed to delete mission. Please try again.');
                }
            }
        };

        window.approveMission = async (missionId, event) => {
            event.stopPropagation();
            
            try {
                await updateDoc(doc(db, 'missions', missionId), {
                    status: 'active'
                });
            } catch (error) {
                console.error('Error approving mission:', error);
                alert('Failed to approve mission. Please try again.');
            }
        };

        window.completeMission = async (missionId, event) => {
            event.stopPropagation();
            
            const mission = missions.find(m => m.id === missionId);
            if (!mission) return;
            
            try {
                // Calculate points with decay if overdue
                let finalPoints = mission.points;
                let decayMessage = '';
                
                if (mission.dueDate) {
                    const dueDate = new Date(mission.dueDate);
                    const now = new Date();
                    const daysOverdue = Math.floor((now - dueDate) / (1000 * 60 * 60 * 24));
                    
                    if (daysOverdue > 0) {
                        const decayPercent = Math.min(daysOverdue * 10, 90); // 10% per day, max 90%
                        finalPoints = Math.max(Math.round(mission.points * (1 - decayPercent / 100)), 1); // Min 1 point
                        decayMessage = `\n\n‚ö†Ô∏è ${daysOverdue} day(s) overdue: ${decayPercent}% decay applied`;
                    }
                }
                
                // Add completion record with mission details
                await addDoc(collection(db, 'completions'), {
                    familyId: currentFamily.id,
                    memberId: currentMember.id,
                    memberName: currentMember.name || currentMember.email,
                    missionId: missionId,
                    missionTitle: mission.title,
                    points: finalPoints,
                    originalPoints: mission.points,
                    completedAt: serverTimestamp()
                });
                
                // Delete the mission after completion
                await deleteDoc(doc(db, 'missions', missionId));
                
                alert(`Mission completed! +${finalPoints} points${decayMessage}`);
            } catch (error) {
                console.error('Error completing mission:', error);
                alert('Failed to complete mission. Please try again.');
            }
        };

        window.selectMissionPoints = (points, el) => {
            selectedMissionPoints = points;
            document.querySelectorAll('#addMissionModal .points-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        };

        window.selectEditMissionPoints = (points, el) => {
            selectedEditMissionPoints = points;
            document.querySelectorAll('#editMissionModal .points-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        };

        // Routine Functions
        window.addRoutine = async () => {
            const name = document.getElementById('routineName').value.trim();
            if (!name) {
                alert('Please enter a routine name');
                return;
            }

            try {
                await addDoc(collection(db, 'routines'), {
                    userId: currentUser.uid,
                    name: name,
                    tasks: [],
                    createdAt: serverTimestamp()
                });
                
                closeModal('addRoutineModal');
                document.getElementById('routineName').value = '';
            } catch (error) {
                console.error('Error adding routine:', error);
                alert('Failed to add routine. Please try again.');
            }
        };

        window.deleteRoutine = async (routineId, event) => {
            event.stopPropagation();
            
            const routine = routines.find(r => r.id === routineId);
            if (!routine) return;
            
            if (confirm(`Delete routine "${routine.name}"?`)) {
                try {
                    await deleteDoc(doc(db, 'routines', routineId));
                } catch (error) {
                    console.error('Error deleting routine:', error);
                    alert('Failed to delete routine. Please try again.');
                }
            }
        };

        window.showAddTaskToRoutine = (routineId) => {
            currentRoutineId = routineId;
            showModal('addTaskToRoutineModal');
        };

        window.addTaskToRoutine = async () => {
            if (!currentRoutineId) return;
            
            const taskText = document.getElementById('routineTaskText').value.trim();
            if (!taskText) {
                alert('Please enter a task');
                return;
            }

            try {
                const routine = routines.find(r => r.id === currentRoutineId);
                if (!routine) return;
                
                const updatedTasks = [...(routine.tasks || []), taskText];
                
                await updateDoc(doc(db, 'routines', currentRoutineId), {
                    tasks: updatedTasks
                });
                
                closeModal('addTaskToRoutineModal');
                document.getElementById('routineTaskText').value = '';
                currentRoutineId = null;
            } catch (error) {
                console.error('Error adding task to routine:', error);
                alert('Failed to add task. Please try again.');
            }
        };

        window.deleteTaskFromRoutine = async (routineId, taskIndex, event) => {
            event.stopPropagation();
            
            try {
                const routine = routines.find(r => r.id === routineId);
                if (!routine) return;
                
                const updatedTasks = routine.tasks.filter((_, i) => i !== taskIndex);
                
                await updateDoc(doc(db, 'routines', routineId), {
                    tasks: updatedTasks
                });
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Failed to delete task. Please try again.');
            }
        };

        // Member Functions
        window.editMember = (memberId) => {
            currentEditMemberId = memberId;
            const member = allMembers.find(m => m.id === memberId);
            if (!member) return;
            
            document.getElementById('editMemberName').value = member.name || '';
            document.getElementById('editMemberGoal').value = member.pointsGoal || '';
            
            showModal('editMemberModal');
        };

        window.updateMember = async () => {
            if (!currentEditMemberId) return;
            
            const name = document.getElementById('editMemberName').value.trim();
            const goal = parseInt(document.getElementById('editMemberGoal').value) || 0;
            
            if (!name) {
                alert('Please enter a name');
                return;
            }

            try {
                await updateDoc(doc(db, 'members', currentEditMemberId), {
                    name: name,
                    pointsGoal: goal
                });
                
                closeModal('editMemberModal');
                currentEditMemberId = null;
            } catch (error) {
                console.error('Error updating member:', error);
                alert('Failed to update member. Please try again.');
            }
        };

        window.removeMember = async (memberId) => {
            const member = allMembers.find(m => m.id === memberId);
            if (!member) return;
            
            // Double confirmation
            if (!confirm(`Remove ${member.name || member.email} from the family?\n\nThey will no longer have access to this family's data. Their completion history will be preserved in the logs.\n\nThis cannot be undone.`)) {
                return;
            }
            
            if (!confirm(`Are you absolutely sure you want to remove ${member.name || member.email}?`)) {
                return;
            }
            
            try {
                // Delete the member record
                await deleteDoc(doc(db, 'members', memberId));
                
                alert(`${member.name || member.email} has been removed from the family.`);
            } catch (error) {
                console.error('Error removing member:', error);
                alert('Failed to remove member. Please try again.');
            }
        };

        window.toggleRecRoom = async (memberId, enabled) => {
            try {
                await updateDoc(doc(db, 'members', memberId), {
                    recRoomEnabled: enabled
                });
                
                // Reload member data if this is the current user
                if (memberId === currentMember.id) {
                    currentMember.recRoomEnabled = enabled;
                    updateNavigation();
                }
            } catch (error) {
                console.error('Error toggling rec room:', error);
                alert('Failed to update rec room access. Please try again.');
            }
        };

        window.toggleFamilySetting = async (setting) => {
            if (!currentFamily || !currentMember || currentMember.role !== 'parent') return;
            
            const checkbox = document.getElementById(setting === 'streaksEnabled' ? 'streaksToggle' : 'kidsTasksToggle');
            const newValue = checkbox.checked;

            try {
                await updateDoc(doc(db, 'families', currentFamily.id), {
                    [`settings.${setting}`]: newValue
                });
            } catch (error) {
                console.error('Error updating setting:', error);
                alert('Failed to update setting. Please try again.');
                checkbox.checked = !newValue;
            }
        };

        // Navigation
        window.switchTab = (tabName) => {
            // Check if rec room is disabled for kids
            if (tabName === 'recroom') {
                const recRoomNav = document.getElementById('recRoomNav');
                if (recRoomNav.classList.contains('disabled')) {
                    return;
                }
            }
            
            currentTab = tabName;
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');
        };

        // Help tooltip toggle
        window.toggleHelpTooltip = (event) => {
            event.stopPropagation();
            const tooltip = event.currentTarget.querySelector('.help-tooltip');
            const isShowing = tooltip.classList.contains('show');
            
            // Hide all other tooltips
            document.querySelectorAll('.help-tooltip').forEach(t => t.classList.remove('show'));
            
            // Toggle this one
            if (!isShowing) {
                tooltip.classList.add('show');
                
                // Hide when clicking anywhere else
                setTimeout(() => {
                    document.addEventListener('click', function hideTooltip() {
                        tooltip.classList.remove('show');
                        document.removeEventListener('click', hideTooltip);
                    });
                }, 10);
            }
        };

        // Modal Functions
        window.showModal = (id) => {
            document.getElementById(id).classList.add('active');
            
            // Special handling for Add Mission modal
            if (id === 'addMissionModal') {
                const isParent = currentMember && currentMember.role === 'parent';
                
                document.getElementById('missionPointsGroup').style.display = isParent ? 'block' : 'none';
                document.getElementById('missionSideMissionGroup').style.display = isParent ? 'block' : 'none';
                document.getElementById('missionAssigneeGroup').style.display = isParent ? 'block' : 'none';
                
                document.getElementById('addMissionModalTitle').textContent = isParent ? 'Add Mission' : 'Request Mission';
            }
        };

        window.closeModal = (id) => {
            document.getElementById(id).classList.remove('active');
        };

        function showScreen(screen) {
            document.getElementById('loginScreen').classList.toggle('hidden', screen !== 'login');
            document.getElementById('setupScreen').classList.toggle('hidden', screen !== 'setup');
            document.getElementById('mainApp').classList.toggle('hidden', screen !== 'main');
            
            if (screen === 'main' && currentUser.photoURL) {
                document.getElementById('userAvatar').src = currentUser.photoURL;
            }
        }

        // Disclaimer Functions
        window.openDisclaimer = () => {
            document.getElementById('disclaimerDrawer').classList.add('open');
            document.getElementById('disclaimerOverlay').classList.add('active');
        };

        window.closeDisclaimer = () => {
            document.getElementById('disclaimerDrawer').classList.remove('open');
            document.getElementById('disclaimerOverlay').classList.remove('active');
        };

        // Reset All Family Data
        window.resetFamilyData = async () => {
            if (!currentFamily || !currentMember || currentMember.role !== 'parent') {
                alert('Only parents can reset family data');
                return;
            }

            if (!confirm('‚ö†Ô∏è WARNING: This will DELETE ALL missions and completion history for your entire family. This CANNOT be undone.\n\nFamily members, routines, and settings will be kept.\n\nAre you absolutely sure?')) return;
            
            if (!confirm('This is your last chance. Click OK to confirm total deletion.')) return;
            
            const confirmation = prompt('Type YES in all caps to confirm deletion:');
            if (confirmation !== 'YES') {
                alert('Reset cancelled');
                return;
            }
            
            try {
                // Delete all missions
                const missionsToDelete = missions.filter(m => m.familyId === currentFamily.id);
                for (const mission of missionsToDelete) {
                    await deleteDoc(doc(db, 'missions', mission.id));
                }
                
                // Delete all completions
                const completionsToDelete = completions.filter(c => c.familyId === currentFamily.id);
                for (const completion of completionsToDelete) {
                    await deleteDoc(doc(db, 'completions', completion.id));
                }
                
                alert('‚úÖ All mission data has been reset! Starting fresh. Routines and members have been preserved.');
            } catch (error) {
                console.error('Error resetting family data:', error);
                alert('Failed to reset family data. Please try again.');
            }
        };
    </script>
</body>
</html>
